<div class="collection-view">
    <div *ngIf="!validating">

        <div class="grid spacing-12" *ngIf="!loading else loadingDisplay">
            <div class="row width-limited">
                <div class="col" *ngIf="editing">
                    <!-- things to add to the collection -->
                    <app-name-property class="grow-to-row" [config]="{
                        mode: editing? 'edit' : 'view',
                        object: collection
                    }"></app-name-property>
                </div>
                <div class="col" *ngIf="!editing">
                    <div class="labelled-box">
                        <div class="content">{{collection.name}}</div>
                        <label>name</label>
                    </div>
                </div>
                <div class="col">
                    <!-- VERSION NUMBER -->
                    <app-version-property class="grow-to-row" [config]="{
                        mode: editing? 'edit' : 'view',
                        object: collection
                    }"></app-version-property>
                </div>
            </div>
            <div class="row width-limited">
                <div class="col">
                    <!-- DESCRIPTION -->
                    <app-descriptive-property [config]="{
                        mode: editing? 'edit' : 'view',
                        object: collection,
                        field: 'description',
                        firstParagraphOnly: false, 
                        label: 'Description'
                    }"></app-descriptive-property>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <h2 class="section-header">Changes in this release</h2>
                </div>
            </div>
            <!-- LIST BUILDER / DUAL LIST UI -->
            <!-- <div class="row">
                <div class="col center">
                    <h4 class="text-label">Objects in Knowledge Base</h4>
                </div>
                <div class="col center">
                    <h4 class="text-label">Objects in Collection</h4>
                </div>
            </div> !-->
            <div class="row">
                <div class="col changes" *ngIf="editingReloadToggle">
                    <mat-accordion>
                        <mat-expansion-panel *ngFor="let attackType of ['matrix', 'technique', 'tactic', 'mitigation', 'group', 'software']" class="mat-elevation-z0">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    <h3>{{attackType}}</h3>
                                </mat-panel-title>
                            </mat-expansion-panel-header>
                            <ng-template matExpansionPanelContent>
                                <mat-accordion>
                                    <mat-expansion-panel class="mat-elevation-z0">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                Additions
                                            </mat-panel-title>
                                            <mat-panel-description>
                                                New objects
                                            </mat-panel-description>
                                        </mat-expansion-panel-header>
                                        <ng-template matExpansionPanelContent>
                                            <div class="grid spacing-0">
                                                <div class="row">
                                                    <div class="col center vertical-center" *ngIf="editing">
                                                        <h4 class="text-label">Objects not in the collection</h4>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing"></div>
                                                    <div class="col center vertical-center">
                                                        <h4 class="text-label">Objects added in this release</h4>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col" *ngIf="editing">
                                                        <app-stix-list #potentialAdditionsRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': potentialChanges[attackType].additions,
                                                            'rowAction': {
                                                                'icon': 'keyboard_arrow_right',
                                                                'tooltip': 'stage addition',
                                                                'position': 'end'
                                                            }
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'additions', 'stage', [potentialAdditionsRef, collectionAdditionsRef])"></app-stix-list>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing">
                                                        <button mat-icon-button 
                                                                matTooltip="stage all additions" 
                                                                [disabled]="potentialChanges[attackType].additions.length == 0"
                                                                (click)="moveChanges(potentialChanges[attackType].additions, attackType, 'additions', 'stage', [potentialAdditionsRef, collectionAdditionsRef])">
                                                            <mat-icon aria-label="move all to collection">double_arrow</mat-icon>
                                                        </button>
                                                        <button mat-icon-button 
                                                                matTooltip="unstage all additions" 
                                                                [disabled]="collectionChanges[attackType].additions.length == 0"
                                                                (click)="moveChanges(collectionChanges[attackType].additions, attackType, 'additions', 'unstage', [potentialAdditionsRef, collectionAdditionsRef])">
                                                            <mat-icon aria-label="move all from collection" class="icon-mirror">double_arrow</mat-icon>
                                                        </button>
                                                    </div>
                                                    <div class="col">
                                                        <app-stix-list #collectionAdditionsRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': collectionChanges[attackType].additions,
                                                            'rowAction': editing? {
                                                                'icon': 'keyboard_arrow_left',
                                                                'tooltip': 'unstage addition',
                                                                'position': 'start'
                                                            } : null
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'additions', 'unstage', [potentialAdditionsRef, collectionAdditionsRef])"></app-stix-list>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </mat-expansion-panel>
                                    <mat-expansion-panel class="mat-elevation-z0">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                Changes
                                            </mat-panel-title>
                                            <mat-panel-description>
                                                Changed objects
                                            </mat-panel-description>
                                        </mat-expansion-panel-header>
                                        <ng-template matExpansionPanelContent>
                                            <div class="grid spacing-0">
                                                <div class="row">
                                                    <div class="col center vertical-center vertical-center" *ngIf="editing">
                                                        <h4 class="text-label">Newer versions available in the knowledge base</h4>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing"></div>
                                                    <div class="col center vertical-center vertical-center">
                                                        <h4 class="text-label">Objects updated in this release</h4>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col" *ngIf="editing">
                                                        <app-stix-list #potentialChangesRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': potentialChanges[attackType].changes,
                                                            'rowAction': {
                                                                'icon': 'keyboard_arrow_right',
                                                                'tooltip': 'stage change',
                                                                'position': 'end'
                                                            }
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'changes', 'stage', [potentialChangesRef, collectionChangesRef])"></app-stix-list>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing">
                                                        <button mat-icon-button 
                                                                matTooltip="stage all changes" 
                                                                [disabled]="potentialChanges[attackType].changes.length == 0"
                                                                (click)="moveChanges(potentialChanges[attackType].changes, attackType, 'changes', 'stage', [potentialChangesRef, collectionChangesRef])">
                                                                <mat-icon aria-label="move all to collection">double_arrow</mat-icon>
                                                        </button>
                                                        <button mat-icon-button 
                                                                matTooltip="unstage all changes" 
                                                                [disabled]="collectionChanges[attackType].changes.length == 0"
                                                                (click)="moveChanges(collectionChanges[attackType].changes, attackType, 'changes', 'unstage', [potentialChangesRef, collectionChangesRef])">
                                                            <mat-icon aria-label="move all from collection" class="icon-mirror">double_arrow</mat-icon>
                                                        </button>
                                                    </div>
                                                    <div class="col">
                                                        <app-stix-list #collectionChangesRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': collectionChanges[attackType].changes,
                                                            'rowAction': editing? {
                                                                'icon': 'keyboard_arrow_left',
                                                                'tooltip': 'unstage change',
                                                                'position': 'start'
                                                            } : null
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'changes', 'unstage', [potentialChangesRef, collectionChangesRef])"></app-stix-list>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </mat-expansion-panel>
                                    <mat-expansion-panel class="mat-elevation-z0">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                Minor Changes
                                            </mat-panel-title>
                                            <mat-panel-description>
                                                Objects with minor changes
                                            </mat-panel-description>
                                        </mat-expansion-panel-header>
                                        <ng-template matExpansionPanelContent>
                                            <div class="grid spacing-0">
                                                <div class="row">
                                                    <div class="col center vertical-center vertical-center" *ngIf="editing">
                                                        <h4 class="text-label">Newer versions available in the knowledge base</h4>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing"></div>
                                                    <div class="col center vertical-center vertical-center">
                                                        <h4 class="text-label">Objects updated in this release</h4>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col" *ngIf="editing">
                                                        <app-stix-list #potentialMinorChangesRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': potentialChanges[attackType].minor_changes,
                                                            'rowAction': {
                                                                'icon': 'keyboard_arrow_right',
                                                                'tooltip': 'stage minor change',
                                                                'position': 'end'
                                                            }
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'minor_changes', 'stage', [potentialMinorChangesRef, collectionMinorChangesRef])"></app-stix-list>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing">
                                                        <button mat-icon-button 
                                                                matTooltip="stage all minor changes" 
                                                                [disabled]="potentialChanges[attackType].minor_changes.length == 0"
                                                                (click)="moveChanges(potentialChanges[attackType].minor_changes, attackType, 'minor_changes', 'stage', [potentialMinorChangesRef, collectionMinorChangesRef])">
                                                            <mat-icon aria-label="move all to collection">double_arrow</mat-icon>
                                                        </button>
                                                        <button mat-icon-button 
                                                                matTooltip="unstage all minor changes" 
                                                                [disabled]="collectionChanges[attackType].minor_changes.length == 0"
                                                                (click)="moveChanges(collectionChanges[attackType].minor_changes, attackType, 'minor_changes', 'unstage', [potentialMinorChangesRef, collectionMinorChangesRef])">
                                                            <mat-icon aria-label="move all from collection" class="icon-mirror">double_arrow</mat-icon>
                                                        </button>
                                                    </div>
                                                    <div class="col">
                                                        <app-stix-list #collectionMinorChangesRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': collectionChanges[attackType].minor_changes,
                                                            'rowAction': editing? {
                                                                'icon': 'keyboard_arrow_left',
                                                                'tooltip': 'unstage minor change',
                                                                'position': 'start'
                                                            } : null
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'minor_changes', 'unstage', [potentialMinorChangesRef, collectionMinorChangesRef])"></app-stix-list>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </mat-expansion-panel>
                                    <mat-expansion-panel class="mat-elevation-z0">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                Revocations
                                            </mat-panel-title>
                                            <mat-panel-description>
                                                Objects replaced by other objects
                                            </mat-panel-description>
                                        </mat-expansion-panel-header>
                                        <ng-template matExpansionPanelContent>
                                            <div class="grid spacing-0">
                                                <div class="row">
                                                    <div class="col center vertical-center vertical-center" *ngIf="editing">
                                                        <h4 class="text-label">Objects revoked in the knowledge base</h4>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing"></div>
                                                    <div class="col center vertical-center vertical-center">
                                                        <h4 class="text-label">Objects revoked by this release</h4>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col" *ngIf="editing">
                                                        <app-stix-list #potentialRevocationsRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': potentialChanges[attackType].revocations,
                                                            'rowAction': {
                                                                'icon': 'keyboard_arrow_right',
                                                                'tooltip': 'stage addition',
                                                                'position': 'end'
                                                            }
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'revocations', 'stage', [potentialRevocationsRef, collectionRevocationsRef])"></app-stix-list>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing">
                                                        <button mat-icon-button 
                                                                matTooltip="stage all revocations" 
                                                                [disabled]="potentialChanges[attackType].revocations.length == 0"
                                                                (click)="moveChanges(potentialChanges[attackType].revocations, attackType, 'revocations', 'stage', [potentialRevocationsRef, collectionRevocationsRef])">
                                                            <mat-icon aria-label="move all to collection">double_arrow</mat-icon>
                                                        </button>
                                                        <button mat-icon-button 
                                                                matTooltip="unstage all revocations" 
                                                                [disabled]="collectionChanges[attackType].revocations.length == 0"
                                                                (click)="moveChanges(collectionChanges[attackType].revocations, attackType, 'revocations', 'unstage', [potentialRevocationsRef, collectionRevocationsRef])">
                                                            <mat-icon aria-label="move all from collection" class="icon-mirror">double_arrow</mat-icon>
                                                        </button>
                                                    </div>
                                                    <div class="col">
                                                        <app-stix-list #collectionRevocationsRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': collectionChanges[attackType].revocations,
                                                            'rowAction': editing? {
                                                                'icon': 'keyboard_arrow_left',
                                                                'tooltip': 'unstage addition',
                                                                'position': 'start'
                                                            } : null
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'revocations', 'unstage', [potentialRevocationsRef, collectionRevocationsRef])"></app-stix-list>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </mat-expansion-panel>
                                    <mat-expansion-panel class="mat-elevation-z0">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                Deprecations
                                            </mat-panel-title>
                                            <mat-panel-description>
                                                Objects removed from the collection
                                            </mat-panel-description>
                                        </mat-expansion-panel-header>
                                        <ng-template matExpansionPanelContent>
                                            <div class="grid spacing-0">
                                                <div class="row">
                                                    <div class="col center vertical-center vertical-center" *ngIf="editing">
                                                        <h4 class="text-label">Objects deprecated in the knowledge base</h4>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing"></div>
                                                    <div class="col center vertical-center vertical-center">
                                                        <h4 class="text-label">Objects deprecated by this release</h4>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col" *ngIf="editing">
                                                        <app-stix-list #potentialDeprecationsRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': potentialChanges[attackType].deprecations,
                                                            'rowAction': {
                                                                'icon': 'keyboard_arrow_right',
                                                                'tooltip': 'stage deprecation',
                                                                'position': 'end'
                                                            }
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'deprecations', 'stage', [potentialDeprecationsRef, collectionDeprecationsRef])"></app-stix-list>
                                                    </div>
                                                    <div class="col controls narrow" *ngIf="editing">
                                                        <button mat-icon-button 
                                                                matTooltip="stage all deprecations" 
                                                                [disabled]="potentialChanges[attackType].deprecations.length == 0"
                                                                (click)="moveChanges(potentialChanges[attackType].deprecations, attackType, 'deprecations', 'stage', [potentialDeprecationsRef, collectionDeprecationsRef])">
                                                            <mat-icon aria-label="move all to collection">double_arrow</mat-icon>
                                                        </button>
                                                        <button mat-icon-button 
                                                                matTooltip="unstage all deprecations" 
                                                                [disabled]="collectionChanges[attackType].deprecations.length == 0"
                                                                (click)="moveChanges(collectionChanges[attackType].deprecations, attackType, 'deprecations', 'unstage', [potentialDeprecationsRef, collectionDeprecationsRef])">
                                                            <mat-icon aria-label="move all from collection" class="icon-mirror">double_arrow</mat-icon>
                                                        </button>
                                                    </div>
                                                    <div class="col">
                                                        <app-stix-list #collectionDeprecationsRef [config]="{
                                                            'clickBehavior': 'dialog',
                                                            'type': attackType,
                                                            'stixObjects': collectionChanges[attackType].deprecations,
                                                            'rowAction': editing? {
                                                                'icon': 'keyboard_arrow_left',
                                                                'tooltip': 'unstage deprecation',
                                                                'position': 'start'
                                                            } : null
                                                        }"
                                                        (onRowAction)="moveChanges([$event], attackType, 'deprecations', 'unstage', [potentialDeprecationsRef, collectionDeprecationsRef])"></app-stix-list>
                                                    </div>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </mat-expansion-panel>
                                    <mat-expansion-panel class="mat-elevation-z0">
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>
                                                Unchanged
                                            </mat-panel-title>
                                            <mat-panel-description>
                                                Objects that haven't changed since the prior release
                                            </mat-panel-description>
                                        </mat-expansion-panel-header>
                                        <ng-template matExpansionPanelContent>
                                            <app-stix-list [config]="{
                                                'clickBehavior': 'dialog',
                                                'type': attackType,
                                                'stixObjects': collectionChanges[attackType].duplicates
                                            }"></app-stix-list>
                                        </ng-template>
                                    </mat-expansion-panel>
                                </mat-accordion>
                            </ng-template>
                        </mat-expansion-panel>
                        <mat-expansion-panel  class="mat-elevation-z0">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    <h3>Relationship</h3>
                                </mat-panel-title>
                            </mat-expansion-panel-header>
                            <ng-template matExpansionPanelContent>
                                Relationships included in the collection will be updated automatically when the collection is saved.
                                <ul>
                                    <li>
                                        All relationships between objects in the collection will be included at their most recent version.
                                        <ul>
                                            <li>
                                                New relationships between objects already in the collection will be included even if their attached objects did not change.
                                            </li>
                                            <li>
                                                Existing relationships will be updated if newer versions are available even if the objects they are attached to did not change.
                                            </li>
                                            <li>
                                                Updated relationships will exist at the version they existed at when the collection is saved; further updates to relationships after saving will not be included.
                                            </li>
                                        </ul>
                                    </li>
                                    <li>
                                        Relationships will <i>not</i> be included if only one of their attached objects is in the collection.
                                    </li>
                                    <li>
                                        Relationships conveying revocations will be included only if the revoked version of the object they are attached to is included (staged) in the collection. Objects which have revoked versions <i>not</i> included in the collection won't trigger the inclusion of revoking relationships.
                                    </li>
                                </ul>
                            </ng-template>
                        </mat-expansion-panel>
                    </mat-accordion>
                </div>
            </div>
        </div>
        <ng-template #loadingDisplay>
            <app-loading-overlay [message]="loading"></app-loading-overlay>
        </ng-template>
    </div>
    <div *ngIf="validating">
        <div *ngIf="validationData else loadingValidation">
            <app-validation-results [validation]="validationData"></app-validation-results>
        </div>
        <ng-template #loadingValidation>
            <app-loading-overlay [message]="validating"></app-loading-overlay>
        </ng-template>
    </div>
</div>
